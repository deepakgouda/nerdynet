<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Mocking in C++ | Deepak Gouda</title> <meta name="author" content="Deepak Gouda"/> <meta name="description" content="My notes on setting up gtest and gmock in C++."/> <meta name="keywords" content="academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="/assets/img/title-icon.png"/> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://deepakgouda.github.io/blog/2022/unit_testing/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://deepakgouda.github.io/"><span class="font-weight-bold">Deepak</span> Gouda</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/shots/">shots</a> </li> <li class="nav-item "> <a class="nav-link" href="/gallery/">gallery</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/talks/">talks</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/genealogy/">genealogy</a> <a class="dropdown-item" href="/checklist/">checklist</a> </div> </li> <div class="toggle-container"> <a id="light-toggle"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </a> </div> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Mocking in C++</h1> <p class="post-meta">June 1, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/cpp"> <i class="fas fa-hashtag fa-sm"></i> cpp</a>   <a href="/blog/tag/tech"> <i class="fas fa-hashtag fa-sm"></i> tech</a>   <a href="/blog/tag/setup"> <i class="fas fa-hashtag fa-sm"></i> setup</a>     ·   <a href="/blog/category/Setup"> <i class="fas fa-tag fa-sm"></i> Setup</a>   </p> </header> <article class="post-content"> <h1 id="unit-testing-in-c-using-googletest-and-gmock">Unit testing in C++ using GoogleTest and gMock</h1> <hr> <h2 id="installation">Installation</h2> <h3 id="build-from-source">Build from source</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/google/googletest.git <span class="nt">-b</span> release-1.11.0
<span class="nb">cd </span>googletest
<span class="nb">mkdir </span>build
<span class="nb">cd </span>build
cmake ..
make
make <span class="nb">install</span>
</code></pre></div></div> <h3 id="add-to-existing-cmake-configuration">Add to existing cmake configuration</h3> <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CMakeLists.txt.in</span>
<span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.15.0<span class="p">)</span>

<span class="nb">project</span><span class="p">(</span>googletest-download NONE<span class="p">)</span>

<span class="nb">include</span><span class="p">(</span>ExternalProject<span class="p">)</span>
<span class="nf">ExternalProject_Add</span><span class="p">(</span>googletest
  GIT_REPOSITORY    https://github.com/google/googletest.git
  GIT_TAG           release-1.11.0
  SOURCE_DIR        <span class="s2">"</span><span class="si">${</span><span class="nv">CMAKE_CURRENT_BINARY_DIR</span><span class="si">}</span><span class="s2">/googletest-src"</span>
  BINARY_DIR        <span class="s2">"</span><span class="si">${</span><span class="nv">CMAKE_CURRENT_BINARY_DIR</span><span class="si">}</span><span class="s2">/googletest-build"</span>
  CONFIGURE_COMMAND <span class="s2">""</span>
  BUILD_COMMAND     <span class="s2">""</span>
  INSTALL_COMMAND   <span class="s2">""</span>
  TEST_COMMAND      <span class="s2">""</span>
<span class="p">)</span>
</code></pre></div></div> <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">configure_file</span><span class="p">(</span>CMakeLists.txt.in googletest-download/CMakeLists.txt<span class="p">)</span>
<span class="nb">execute_process</span><span class="p">(</span>COMMAND <span class="si">${</span><span class="nv">CMAKE_COMMAND</span><span class="si">}</span> -G <span class="s2">"</span><span class="si">${</span><span class="nv">CMAKE_GENERATOR</span><span class="si">}</span><span class="s2">"</span> .
  RESULT_VARIABLE result
  WORKING_DIRECTORY <span class="si">${</span><span class="nv">CMAKE_CURRENT_BINARY_DIR</span><span class="si">}</span>/googletest-download <span class="p">)</span>
<span class="nb">if</span><span class="p">(</span>result<span class="p">)</span>
  <span class="nb">message</span><span class="p">(</span>FATAL_ERROR <span class="s2">"CMake step for googletest failed: </span><span class="si">${</span><span class="nv">result</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
<span class="nb">execute_process</span><span class="p">(</span>COMMAND <span class="si">${</span><span class="nv">CMAKE_COMMAND</span><span class="si">}</span> --build .
  RESULT_VARIABLE result
  WORKING_DIRECTORY <span class="si">${</span><span class="nv">CMAKE_CURRENT_BINARY_DIR</span><span class="si">}</span>/googletest-download <span class="p">)</span>
<span class="nb">if</span><span class="p">(</span>result<span class="p">)</span>
  <span class="nb">message</span><span class="p">(</span>FATAL_ERROR <span class="s2">"Build step for googletest failed: </span><span class="si">${</span><span class="nv">result</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
<span class="nb">add_subdirectory</span><span class="p">(</span><span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span>/googletest-src
                 <span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span>/googletest-build
                 EXCLUDE_FROM_ALL<span class="p">)</span>

<span class="nb">set</span><span class="p">(</span>TESTS ./tests/test.cpp<span class="p">)</span>
<span class="nb">add_executable</span><span class="p">(</span>unit_test <span class="si">${</span><span class="nv">TESTS</span><span class="si">}</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span>unit_test gtest_main<span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span>unit_test gmock<span class="p">)</span>
</code></pre></div></div> <h2 id="sample-binary">Sample binary</h2> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// a.hpp</span>
<span class="cp">#ifndef A_HPP
#define A_HPP
</span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
</span>
<span class="kt">char</span> <span class="nf">getByte</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">writeByte</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="nf">readByte</span><span class="p">();</span>
<span class="cp">#endif
</span></code></pre></div></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// a.cpp</span>
<span class="cp">#include</span> <span class="cpf">"a.hpp"</span><span class="cp">
</span>
<span class="kt">char</span> <span class="nf">getByte</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">writeByte</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">file_wrtr</span><span class="p">;</span>
	<span class="n">file_wrtr</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"dump.log"</span><span class="p">);</span>
	<span class="n">file_wrtr</span> <span class="o">&lt;&lt;</span> <span class="n">str</span><span class="p">;</span>
	<span class="n">file_wrtr</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="nf">readByte</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file_rdr</span><span class="p">(</span><span class="s">"dump.log"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file_rdr</span><span class="p">.</span><span class="n">is_open</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">file_rdr</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">line</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">file_rdr</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">line</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// main_test.cpp</span>
<span class="cp">#include</span> <span class="cpf">"a.hpp"</span><span class="cp">
#include</span> <span class="cpf">"gtest/gtest.h"</span><span class="cp">
</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">DummyTest</span><span class="p">,</span> <span class="n">getByte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">'a'</span><span class="p">};</span>
	<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="sc">'a'</span><span class="p">,</span> <span class="n">getByte</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">DummyTest</span><span class="p">,</span> <span class="n">readByte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"Hello, world!"</span><span class="p">;</span>
	<span class="n">writeByte</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">readByte</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">InitGoogleTest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">RUN_ALL_TESTS</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// main.cpp</span>
<span class="cp">#include</span> <span class="cpf">"a.hpp"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">'a'</span><span class="p">};</span>
	<span class="n">std</span> <span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">getByte</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"Hello, world!"</span><span class="p">;</span>
	<span class="n">writeByte</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">readByte</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="cmake-configuration">CMake configuration</h2> <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.15.0<span class="p">)</span>
<span class="nb">project</span><span class="p">(</span>Test VERSION 0.1.0<span class="p">)</span>

<span class="nb">set</span><span class="p">(</span>CMAKE_CXX_STANDARD 20<span class="p">)</span>
<span class="nb">set</span><span class="p">(</span>CMAKE_CXX_STANDARD_REQUIRED True<span class="p">)</span>

<span class="nb">set</span><span class="p">(</span>FILES_TO_TEST a.cpp<span class="p">)</span>
<span class="nb">set</span><span class="p">(</span>UNIT_TESTS main_test.cpp<span class="p">)</span>
<span class="nb">set</span><span class="p">(</span>MAIN_FILE main.cpp<span class="p">)</span>

<span class="nb">add_subdirectory</span><span class="p">(</span>googletest/<span class="p">)</span>
<span class="nb">include_directories</span><span class="p">(</span>googletest/include<span class="p">)</span>
<span class="nb">add_library</span><span class="p">(</span>files_to_test <span class="si">${</span><span class="nv">FILES_TO_TEST</span><span class="si">}</span><span class="p">)</span>

<span class="nb">enable_testing</span><span class="p">()</span>
<span class="nb">add_executable</span><span class="p">(</span>main <span class="si">${</span><span class="nv">MAIN_FILE</span><span class="si">}</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span>main files_to_test<span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span>unit_test <span class="si">${</span><span class="nv">UNIT_TESTS</span><span class="si">}</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span>unit_test gtest gtest_main rt pthread files_to_test<span class="p">)</span>

<span class="nb">include</span><span class="p">(</span>GoogleTest<span class="p">)</span>
<span class="nf">gtest_discover_tests</span><span class="p">(</span>unit_test<span class="p">)</span>
</code></pre></div></div> <p>Run using <code class="language-plaintext highlighter-rouge">ctest</code> or <code class="language-plaintext highlighter-rouge">./unit_test</code></p> <h2 id="basics">Basics</h2> <ul> <li> <em>Assertions</em> - statements that check whether a condition is true. Assertion’s result can be <em>success</em>, <em>nonfatal failure</em>, or <em>fatal failure</em>. If a fatal failure occurs, it aborts the current function; otherwise the program continues normally.</li> <li>A <em>test suite</em> contains one or many tests. You should group your tests into test suites that reflect the structure of the tested code. When multiple tests in a test suite need to share common objects and subroutines, you can put them into a <em>test fixture</em> class.</li> <li>A <em>test program</em> can contain multiple test suites.</li> <li> <code class="language-plaintext highlighter-rouge">EXPECT_*</code> versions generate nonfatal failures, which don’t abort the current function.</li> <li> <code class="language-plaintext highlighter-rouge">ASSERT_*</code> versions generate fatal failures when they fail, and <strong>abort the current function</strong>.</li> <li> <code class="language-plaintext highlighter-rouge">ASSERT_*</code> may cause a space leak as it returns from the current function immediately, possibly skipping clean-up code. Hence, you may get a heap checker error in addition to assertion errors.</li> <li>Providing custom failure message : <div class="language-cpp highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>  <span class="n">ASSERT_EQ</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">y</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="s">"Vectors x and y are of unequal length"</span><span class="p">;</span>
</code></pre></div> </div> </li> </ul> <h2 id="creating-a-test">Creating a Test</h2> <p><code class="language-plaintext highlighter-rouge">TEST()</code> - These are ordinary C++ functions that don’t return a value.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TEST</span><span class="p">(</span><span class="n">TestSuiteName</span><span class="p">,</span> <span class="n">TestName</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span> <span class="n">test</span> <span class="n">body</span> <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>Note</strong> : <code class="language-plaintext highlighter-rouge">TestSuiteName</code> and <code class="language-plaintext highlighter-rouge">TestName</code> names must be valid C++ identifiers, and they should not contain any underscores (<code class="language-plaintext highlighter-rouge">_</code>)</p> <h2 id="creating-a-test-fixture">Creating a Test Fixture</h2> <p>If you find yourself writing two or more tests that operate on similar data, you can use a <em>test fixture</em>. This allows you to reuse the same configuration of objects for several different tests.</p> <p>To create a fixture:</p> <ol> <li>Derive a class from <code class="language-plaintext highlighter-rouge">::testing::Test</code> . Start its body with <code class="language-plaintext highlighter-rouge">protected:</code>, as we’ll want to access fixture members from sub-classes.</li> <li>Inside the class, declare any objects you plan to use.</li> <li>If necessary, write a default constructor or <code class="language-plaintext highlighter-rouge">SetUp()</code> function to prepare the objects for each test. Use <code class="language-plaintext highlighter-rouge">override</code> in C++11 to make sure you spelled it correctly.</li> <li>If necessary, write a destructor or <code class="language-plaintext highlighter-rouge">TearDown()</code> function to release any resources you allocated in <code class="language-plaintext highlighter-rouge">SetUp()</code> . To learn when you should use the constructor/destructor and when you should use <code class="language-plaintext highlighter-rouge">SetUp()/TearDown()</code>, read the <a href="https://google.github.io/googletest/faq.html#CtorVsSetUp" target="_blank" rel="noopener noreferrer">FAQ</a>.</li> <li>If needed, define subroutines for your tests to share.</li> </ol> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TEST_F</span><span class="p">(</span><span class="n">TestFixtureName</span><span class="p">,</span> <span class="n">TestName</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span> <span class="n">test</span> <span class="n">body</span> <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>Note</strong> : First define a test fixture class before using it in a <code class="language-plaintext highlighter-rouge">TEST_F()</code>, or you’ll get the compiler error “<code class="language-plaintext highlighter-rouge">virtual outside class declaration</code>”.</p> <p>For each test defined with <code class="language-plaintext highlighter-rouge">TEST_F()</code>, googletest will create a <em>fresh</em> test fixture at runtime, immediately initialize it via <code class="language-plaintext highlighter-rouge">SetUp()</code>, run the test, clean up by calling <code class="language-plaintext highlighter-rouge">TearDown()</code>, and then delete the test fixture.</p> <p><em>googletest</em> does <strong>not</strong> reuse the same test fixture for multiple tests.</p> <h3 id="example">Example</h3> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">E</span><span class="p">&gt;</span>  <span class="c1">// E is the element type.</span>
<span class="k">class</span> <span class="nc">Queue</span> <span class="p">{</span>
	<span class="nl">public:</span>
	<span class="n">Queue</span><span class="p">();</span>
	<span class="kt">void</span> <span class="n">Enqueue</span><span class="p">(</span><span class="k">const</span> <span class="n">E</span><span class="o">&amp;</span> <span class="n">element</span><span class="p">);</span>
	<span class="n">E</span><span class="o">*</span> <span class="n">Dequeue</span><span class="p">();</span>  <span class="c1">// Returns NULL if the queue is empty.</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
	<span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">QueueTest</span> <span class="o">:</span> <span class="k">public</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Test</span> <span class="p">{</span>
	<span class="nl">protected:</span>
	<span class="kt">void</span> <span class="n">SetUp</span><span class="p">()</span> <span class="k">override</span>
	<span class="p">{</span>
		<span class="n">q1_</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">q2_</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">q2_</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1">// void TearDown() override {}</span>
	<span class="n">Queue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">q0_</span><span class="p">;</span>
	<span class="n">Queue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">q1_</span><span class="p">;</span>
	<span class="n">Queue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">q2_</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">TEST_F</span><span class="p">(</span><span class="n">QueueTest</span><span class="p">,</span> <span class="n">IsEmptyInitially</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">q0_</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">TEST_F</span><span class="p">(</span><span class="n">QueueTest</span><span class="p">,</span> <span class="n">DequeueWorks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span><span class="o">*</span> <span class="n">n</span> <span class="o">=</span> <span class="n">q0_</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
	<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
	
	<span class="n">n</span> <span class="o">=</span> <span class="n">q1_</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
	<span class="n">ASSERT_NE</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
	<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">q1_</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">delete</span> <span class="n">n</span><span class="p">;</span>
	
	<span class="n">n</span> <span class="o">=</span> <span class="n">q2_</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
	<span class="n">ASSERT_NE</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
	<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">q2_</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">delete</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>Note</strong> :</p> <ul> <li>You must <strong>not</strong> ignore the return value of <code class="language-plaintext highlighter-rouge">RUN_ALL_TESTS()</code>, or you will get a compiler error.</li> <li>You should call <code class="language-plaintext highlighter-rouge">RUN_ALL_TESTS()</code> only <strong>once</strong>. Calling it more than once conflicts with some advanced googletest features</li> </ul> <h2 id="gmock">gMock</h2> <p>When you write a prototype or test, often it’s not feasible or wise to rely on real objects entirely. A <strong>mock object</strong> implements the same interface as a real object (so it can be used as one), but lets you specify at run time how it will be used and what it should do (which methods will be called? in which order? how many times? with what arguments? what will they return? etc).</p> <h3 id="sample">Sample</h3> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// gmock_test.cpp</span>
<span class="cp">#include</span> <span class="cpf">"a.hpp"</span><span class="cp">
#include</span> <span class="cpf">"gmock/gmock.h"</span><span class="cp">
#include</span> <span class="cpf">"gtest/gtest.h"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">FooBarMock</span> <span class="o">:</span> <span class="k">public</span> <span class="n">FooBar</span>
<span class="p">{</span>
<span class="nl">public:</span>
	<span class="n">MOCK_METHOD</span><span class="p">(</span><span class="kt">char</span><span class="p">,</span> <span class="n">getByte</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">MOCK_METHOD</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">writeByte</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="p">));</span>
	<span class="n">MOCK_METHOD</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">readByte</span><span class="p">,</span> <span class="p">());</span>
<span class="p">};</span>

<span class="k">using</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">AtLeast</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">FooBarMock</span><span class="p">,</span> <span class="n">CanReadFile</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FooBarMock</span> <span class="n">foo</span><span class="p">;</span>
	<span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="n">readByte</span><span class="p">()).</span><span class="n">Times</span><span class="p">(</span><span class="n">AtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">foo</span><span class="p">.</span><span class="n">writeByte</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">);</span>
	<span class="n">foo</span><span class="p">.</span><span class="n">readByte</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>Note</strong> : gMock requires expectations to be set <strong>before</strong> the mock functions are called, otherwise the behavior is <strong>undefined</strong>.</p> <h2 id="delegating-calls-to-fake-class">Delegating calls to Fake class</h2> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FakeFooBar</span> <span class="o">:</span> <span class="k">public</span> <span class="n">FooBar</span>
<span class="p">{</span>
<span class="nl">public:</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">readByte</span><span class="p">()</span> <span class="k">override</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="s">"Child hello!"</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">MockFooBar</span> <span class="o">:</span> <span class="k">public</span> <span class="n">FooBar</span>

<span class="p">{</span>
<span class="nl">private:</span>
	<span class="n">FakeFooBar</span> <span class="n">fake_</span><span class="p">;</span>
<span class="nl">public:</span>
	<span class="n">MOCK_METHOD</span><span class="p">(</span><span class="kt">char</span><span class="p">,</span> <span class="n">getByte</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="k">override</span><span class="p">));</span>
	<span class="n">MOCK_METHOD</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">writeByte</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="p">),</span> <span class="p">(</span><span class="k">override</span><span class="p">));</span>
	<span class="n">MOCK_METHOD</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">readByte</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="k">override</span><span class="p">));</span>
	
	<span class="kt">void</span> <span class="n">DelegateToFake</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">ON_CALL</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">readByte</span><span class="p">).</span><span class="n">WillByDefault</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span>
			<span class="p">{</span> <span class="k">return</span> <span class="n">fake_</span><span class="p">.</span><span class="n">readByte</span><span class="p">();</span> <span class="p">});</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">FakeFooBar</span><span class="p">,</span> <span class="n">CanFake</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MockFooBar</span><span class="o">&gt;</span> <span class="n">foo</span><span class="p">(</span><span class="k">new</span> <span class="n">MockFooBar</span><span class="p">);</span>
	<span class="n">foo</span><span class="o">-&gt;</span><span class="n">DelegateToFake</span><span class="p">();</span>
	<span class="n">EXPECT_CALL</span><span class="p">(</span><span class="o">*</span><span class="n">foo</span><span class="p">,</span> <span class="n">readByte</span><span class="p">()).</span><span class="n">Times</span><span class="p">(</span><span class="n">AtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">EXPECT_CALL</span><span class="p">(</span><span class="o">*</span><span class="n">foo</span><span class="p">,</span> <span class="n">writeByte</span><span class="p">).</span><span class="n">Times</span><span class="p">(</span><span class="n">AtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">EXPECT_CALL</span><span class="p">(</span><span class="o">*</span><span class="n">foo</span><span class="p">,</span> <span class="n">getByte</span><span class="p">).</span><span class="n">Times</span><span class="p">(</span><span class="n">AtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">ReaderWriter</span> <span class="n">rw</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
	<span class="n">rw</span><span class="p">.</span><span class="n">operation</span><span class="p">();</span>
	<span class="n">foo</span><span class="o">-&gt;</span><span class="n">writeByte</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">);</span>
	<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="s">"Child hello!"</span><span class="p">,</span> <span class="n">foo</span><span class="o">-&gt;</span><span class="n">readByte</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>Note</strong> : A call to <code class="language-plaintext highlighter-rouge">DelegateToFake()</code> is necessary to enable the delegation to fake functions</p> <h2 id="source">Source</h2> <ol> <li><a href="https://google.github.io/googletest/primer.html" target="_blank" rel="noopener noreferrer">googletest primer</a></li> <li><a href="https://google.github.io/googletest/gmock_for_dummies.html" target="_blank" rel="noopener noreferrer">gMock</a></li> <li><a href="https://google.github.io/googletest/gmock_cook_book.html#DelegatingToFake" target="_blank" rel="noopener noreferrer">Delegation to fake</a></li> <li><a href="https://github.com/deepakgouda/unit-testing-cpp" target="_blank" rel="noopener noreferrer">Complete Source</a></li> </ol> </article> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container" style="text-align:center;"> © Copyright 2025 Deepak Gouda. <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer"> Template here!</a>. All images are my own. Last updated: February 06, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script src="/assets/js/zoom.js"></script> <script src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>